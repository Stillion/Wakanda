<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote</title>

    <link rel="stylesheet" type="text/css" href="main.css">
		
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="*"></script>

</head>
<body>

    <div class="container">

        <h1>Vote For Wakanda UN Officials</h1>

        <label for="ddlCandidates">Candidate:</label>
        <select name="ddlCandidates" id="ddlCandidates">
            <option value="default">Select Candidate</option>
        </select>
        
        <hr>

        <label for="lblWkndAmount">WKND Amount:</label>
        <input type="text" id="inWkndAmount" placeholder="Vote = 1 WKND">

        <button id="btnVote">VOTE</button>

        <div id="divLeaderboard" class="hide">

            <label for="ulLeaders">Leaderboard:</label>
            <ul id="ulLeaders">
                <li>test1</li>
                <li>test2</li>
                <li>test3</li>
            </ul>
        </div>

        <button id="btnLeaderboard">Show Leads</button>
    </div>
    
</body>
<script>
    $(document).ready(function() {
        /*API Candidates: https://wakanda.zmilos.com/list
          
          Response: candidates: [
                        {
                            name: string;
                            age: number;
                            cult: string;
                        }
                    ]
        */
        $.get("https://wakanda.zmilos.com/list", function( data ) {
            var candidates = data.candidates;
            $('#ddlCandidates').empty();
            $('#ddlCandidates').append('<option value="">Select A Candidate</option>');
            for (i in candidates ) {
                $('#ddlCandidates').append('<option value="' + candidates[i].name + '">' + candidates[i].name + ', '+ candidates[i].cult + '</option>');
            }
        });

        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        $("#inEthAddress").val(account);
        web3.eth.defaultAccount = account;

    });

    if (typeof web3 !== 'undefined') {
			web3 = new Web3(window.ethereum);
    } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider(window.ethereum));
    }

    var wakandaVotingAbi = [{}];
    var wakandaVotingAddress = '0xd49075AE6335A4E007729507dcF69Dfcad91803C';
    
    var wkndTokenAbi = [{}];
    var wkndTokenAddress = '0xd49075AE6335A4E007729507dcF69Dfcad91803C';

    var WakandaVoting = new web3.eth.Contract(wakandaVotingAbi, wakandaVotingAddress, { from: web3.eth.defaultAccount });
    var WKNDToken = new web3.eth.Contract(wkndTokenAbi, wkndTokenAddress, {from: web3.eth.defaultAccount });

    var numberOfVotes = 0;

    $("#btnVote").click(function(){
        if(numberOfVotes === 0){
            alert("Voted successfully!");
            numberOfVotes++;

            var currentBalanceWKND;

            WKNDToken.methods.balanceOf(web3.eth.defaultAccount).call(function (error, result) {
				if (!error) {
					currentBalanceWKND = result;
				}
				else{
					console.error(error);
					alert("Error occured while getting the WKND balance!");
				}
			});

            var amount = 1000000000000000000;

            if(currentBalanceWKND >= amount){
                WKNDToken.methods.transfer(wkndTokenAddress, amount).send({
                    from: web3.eth.defaultAccount
                });

                WakandaVoting.methods.vote($("#ddlCandidates").val()).send({
                    from: web3.eth.defaultAccount
                });

            }else{
                alert("Not enough WKND coins for voting!");
            }
        }else{
            alert("Voting failed! You've already voted!!");
        }
    });

    $("#btnLeaderboard").click(function(){
        $("#divLeaderboard").toggleClass("hide");
    });

</script>
</html>